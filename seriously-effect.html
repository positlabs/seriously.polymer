
<link rel="import" href="./seriously-node.html">

<polymer-element name="seriously-effect" extends="seriously-node">

	<template>
		
		<template if="{{debug}}">
			<!-- TODO: add controls for debug mode! -->
		</template>

	</template>

	<script>

		/**
			
			wrapper for seriously.effect nodes


			TODO 	serialize attributes
						- boolean
						- number
						- array
						- string

			possible we only need to detect arrays. other types may work as-is.


		*/

		Polymer('seriously-effect', {

			publish: {
				node: {},		// instance of the effect
				type: '',		// type of effect. used to generate effect instance
				sourceID: '', 	// id of input node. used by seriously-graph to connect nodes
				debug: false,	// shows controls for node properties
				_source: {}, 	// the actual Source object. managed by seriously-graph
				_seriously: {}, // instance of Seriously. managed by seriously-graph
			},

			ready: function(){
				this._attrMutationHandler = this._attrMutationHandler.bind(this);
			},

			sourceIDChanged: function(){
				// console.log('seriously-effect.sourceIDChanged', this.sourceID);
				this.fire('sourceIDChanged', {sourceID: this.sourceID});
			},

			_sourceChanged: function(){
				// console.log('seriously-effect._sourceChanged');
				this.node.source = this._source;
			},

			_seriouslyChanged: function(){
				// console.log('seriously-effect.seriouslyChanged');
				this.node = this._seriously.effect(this.type); // invalidate node
				this._setupAttributes();
			},

			// set up mutationObserver for attributes and assign initial values
			_setupAttributes: function(){
				// console.log('seriously-effect._setupAttributes', this.type);

				var inputs = this.node.inputs(),
					keys = Object.keys(inputs),
					watchKeys = [];

				for (var i = keys.length - 1; i >= 0; i--) {
					var key = keys[i];
					if(key !== 'source'){ // source assignment is automated by seriously-graph
						this.node[key] = this.attributes[key].value; // copy props to node
						watchKeys.push(key.toLowerCase()); // attribute names are always lowercase
					}
				}

				if(this.attrObserver) this.attrObserver.close();
				this.attrObserver = new MutationObserver(this._attrMutationHandler);
				this.attrObserver.observe(this, {
					attributes: true,
					subtree: false,
					childList: false,
					characterData: false,
					attributeOldValue: false,
					attributeFilter: watchKeys,
				});

			},

			_attrMutationHandler: function(mutations){
				// console.log('seriously-effect._mutationHandler', mutations);

				for (var i = mutations.length - 1; i >= 0; i--) {
					var m = mutations[i],
						value = this.attributes[m.attributeName].value;
					this.node[m.attributeName] = value;
				};
			},

		});

	</script>

</polymer-element>