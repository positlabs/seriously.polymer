<!-- 

	// Default usage connects nodes with sourceID pointers
	//
	<seriously-graph>
		<seriously-source id="source" >
			<img src="images/pencils.jpg" >
		</seriously-source>
		<seriously-effect id="pxl8" sourceID="source" type="pixelate" ></seriously-effect>
		<seriously-target id="target" sourceID="pxl8" ></seriously-target>
	</seriously-graph>


	// Linear graph chains nodes together in the order they appear.
	// Super cool because it updates node graph when dom elements are re-ordered.
	// e.g. dragging dom nodes in dev tools!
	//
	<seriously-graph linear>
		<seriously-source >
			<img src="images/pencils.jpg" >
		</seriously-source>
		<seriously-effect type="pixelate" ></seriously-effect>
		<seriously-target ></seriously-target>
	</seriously-graph>

 -->

<polymer-element name="seriously-graph">

	<template>
		<content></content>
	</template>

	<script>

		// TODO: connect nodes when inputIDs change
		// listen for an event emitted by seriously components


		Polymer('seriously-graph', {

			publish: {
				linear: false // daisy chain nodes. default is to look for sourceID
			},

			ready: function(){
				this.onNodeSourceIDChanged = this.onNodeSourceIDChanged.bind(this);
			},

			domReady: function(){
				var srsly = this.seriously = new Seriously();

				var nodes = this._getNodes();
				nodes.forEach(function(node){
					node._seriously = srsly;
				});

				setTimeout(function(){ // waiting for change listeners to fire after setting seriously instance on nodes
					this._connectNodes();
					this.onMutation(this, this._mutated);
				}.bind(this), 1);

				this.seriously.go();
			},

			_getNodes: function(){
				// NOTE: might need to use a different method for this to ensure order is maintained.
				return Array.prototype.slice.call(this.querySelectorAll('seriously-source, seriously-target, seriously-effect'));
			},

			// TODO: might need to debounce this
			_connectNodes: function(){
				var nodes = this._getNodes();

				// FIXME: how can we avoid the cyclical ref error produced by seriously?
				// tried setting all node.source's to undefined.
				// tried stopping seriously before source assignment, restarting after new source assignments

				if(this.linear){ // daisy chain

					for (var i = 1; i < nodes.length; i++) {
						nodes[i]._source = nodes[i-1].node;
					}

				}else{ // connect nodes based on sourceID

					nodes.forEach(function(node){
						if(node.sourceID){
							node._source = this.querySelector('#' + node.sourceID).node;
						}
					}.bind(this));
				}

				nodes.forEach(function(node){
					node.removeEventListener('sourceIDChanged', this.onNodeSourceIDChanged); // ensure listeners don't get doubled up
					node.addEventListener('sourceIDChanged', this.onNodeSourceIDChanged);
				}.bind(this));

			},

			onNodeSourceIDChanged: function(){
				// console.log('seriously-graph.onNodeSourceIDChanged', this);
				this._connectNodes();
			},

			_mutated: function(){
				// console.log('seriously-graph._mutated', arguments);
				this._connectNodes(); // reconnect nodes when node order changes 
				this.onMutation(this, this._mutated);
			}

		});
	</script>

</polymer-element>